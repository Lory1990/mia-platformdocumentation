include:
  - project: 'platform/pipelines-templates'
    file: '/build/node/template-react-yarn.yml'
    ref: master

default:
  image: node:16.16.0-alpine

install-dependencies:
  interruptible: true

license-check:
  interruptible: true

test:
  interruptible: true
  script:
    - yarn lint
    - npm run spellcheck
    - npm run check-content
  interruptible: true

variables:
  IMAGE_NAME: core/documentation-site

.docker-job:
  interruptible: true
  dependencies:
    - build-site

build-latest:
  interruptible: true
  rules:
    - if: $CI_COMMIT_TAG
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

build-site:
  interruptible: true
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH
  artifacts:
    when: on_success
    expire_in: 1 day
    paths:
    - build
    - nginx

#deploy-preview:
#  stage: deploy
#  cache:
#    key: "${CI_COMMIT_REF_SLUG}"
#    paths:
#      - node_modules
#      - build
#    policy: pull
#  allow_failure: true
#  variables:
#    STATICDEPLOY_API_URL: ${STATICDEPLOY_API_URL}
#    STATICDEPLOY_API_TOKEN: ${STATICDEPLOY_API_TOKEN}
#    BUNDLE_NAME: 'platform-documentation'
#  script:
#    - ./node_modules/.bin/staticdeploy bundle --config ./staticdeploy.config.js
#    - ./node_modules/.bin/staticdeploy deploy --config ./staticdeploy.config.js
#  rules:
#    - if: $CI_COMMIT_TAG
#      when: never
#    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH

deploy-next:
  stage: deploy
  variables:
    ENVIRONMENT_TO_DEPLOY: PROD
  trigger:
    project: "clients/mia-platform/platform-documentation/configurations"
  only:
    refs:
      - master
